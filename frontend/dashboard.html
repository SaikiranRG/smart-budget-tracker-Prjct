<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - Smart Budget Tracker</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Arial; margin: 30px; text-align: center; }
    nav { margin-bottom: 20px; }
    button { margin-right: 10px; padding: 8px 15px; }
    .card { display: inline-block; padding: 20px; background: #f9f9f9;
            border-radius: 10px; width: 250px; margin: 10px; }
    input { margin: 5px; padding: 5px; }
    .chart-container {
    width: 60%;                 
    max-width: 600px;           
    margin: 20px auto;          
    padding: 15px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }

  canvas {
    width: 100% !important;     
    height: 300px !important; 
  }
  </style>
</head>

<body>

  <!-- Navigation -->
  <nav>
    <button onclick="window.location.href='dashboard.html'">Summary</button>
    <button onclick="window.location.href='transactions.html'">Transactions</button>
    <button onclick="logout()">Logout</button>
  </nav>

  <h2>Financial Summary</h2>

  <!-- Date Filters -->
  <div>
    <label>Start Date:</label>
    <input type="date" id="start">
    <label>End Date:</label>
    <input type="date" id="end">
    <button onclick="getSummary()">Get Summary</button>
  </div>

  <!-- Summary Cards -->
  <div id="summary">
    <div class="card">
      <h3>Total Income</h3>
      <p id="income">$0.00</p>
    </div>

    <div class="card">
      <h3>Total Expenses</h3>
      <p id="expense">$0.00</p>
    </div>

    <div class="card">
      <h3>Balance</h3>
      <p id="balance">$0.00</p>
    </div>
  </div>

  <hr>

  <h2>Spending by Category</h2>
<div class="chart-container">
  <canvas id="categoryChart"></canvas>
</div>

<h2>Income vs Expense (Monthly)</h2>
<div class="chart-container">
  <canvas id="monthlyChart"></canvas>
</div>



  <script>
    const API = "http://localhost:4000/api";
    const token = localStorage.getItem("token");

    if (!token) window.location.href = "index.html";

    let categoryChartInstance = null;
    let monthlyChartInstance = null;

    // ===== LOAD SUMMARY =====
    async function getSummary() {
      const start = document.getElementById('start').value;
      const end = document.getElementById('end').value;

      let url = `${API}/summary`;
      if (start && end) url += `?start=${start}&end=${end}`;

      const res = await fetch(url, {
        headers: { "Authorization": `Bearer ${token}` }
      });

      const data = await res.json();

      document.getElementById('income').textContent = `$${data.total_income || 0}`;
      document.getElementById('expense').textContent = `$${data.total_expense || 0}`;
      document.getElementById('balance').textContent = `$${data.balance || 0}`;
    }

    // ===== PIE CHART =====
    async function loadCategoryChart() {
      const res = await fetch(`${API}/charts/category-totals`, {
        headers: { "Authorization": `Bearer ${token}` }
      });

       const data = await res.json();

  // Convert object â†’ arrays
  const labels = Object.keys(data);   
  console.log(labels)  
  const values = Object.values(data);  

  const ctx = document.getElementById('categoryChart').getContext('2d');

  new Chart(ctx, {
    type: 'pie',
    data: {
      labels: labels,
      datasets: [{
        data: values,
        backgroundColor: [
          '#FF6384', '#36A2EB', '#FFCE56',
          '#4BC0C0', '#9966FF', '#FF9F40'
        ]
        }]
    },
    options: {
      responsive: true,
      plugins: {
        tooltip: {
          callbacks: {
            label: (context) => `${context.label}: $${context.raw}`
          }
        }
      }
    }
  });
}

    // ===== BAR CHART =====
    async function loadMonthlyChart() {
      const res = await fetch(`${API}/charts/monthly-summary`, {
        headers: { "Authorization": `Bearer ${token}` }
      });

      const data = await res.json();
      const ctx = document.getElementById("monthlyChart").getContext("2d");

      if (monthlyChartInstance) monthlyChartInstance.destroy();

      monthlyChartInstance = new Chart(ctx, {
        type: "bar",
        data: {
          labels: data.months,
          datasets: [
            { label: "Income", data: data.income, backgroundColor: "#4caf50" },
            { label: "Expense", data: data.expense, backgroundColor: "#f44336" }
          ]
        }
      });
    }

    function logout() {
      localStorage.removeItem("token");
      window.location.href = "index.html";
    }

    // Load charts and summary by default
    getSummary();
    loadCategoryChart();
    loadMonthlyChart();
  </script>

</body>
</html>
