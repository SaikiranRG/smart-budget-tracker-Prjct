<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - Smart Budget Tracker</title>

  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>

<body>

<div class="layout">

  <!-- Sidebar -->
  <div class="sidebar">
    <h2>Smart Budget</h2>

    <button onclick="window.location.href='dashboard.html'">Dashboard</button>
    <button onclick="window.location.href='transactions.html'">Transactions</button>
    
    <button style="background:#ef4444;" onclick="logout()">Logout</button>
  </div>

  <!-- Main Content -->
  <div class="content">

    <!-- CENTERED WRAPPER -->
    <div class="center-wrapper">

      <div class="page-title">Financial Summary</div>

      <!-- Date Filters -->
      <div class="filter-row center">
        <label>Start Date:</label>
        <input type="date" id="start">

        <label>End Date:</label>
        <input type="date" id="end">

        <button class="save-btn" onclick="getSummary()">Get Summary</button>
      </div>
      <br>
      <!-- SUMMARY CARDS -->
      <div class="summary-cards">
        <div class="card">
          <h3 class="sumry-title">Total Income</h3>
          <p id="income">$0.00</p>
        </div>

        <div class="card">
          <h3 class="sumry-title">Total Expenses</h3>
          <p id="expense">$0.00</p>
        </div>

        <div class="card">
          <h3 class="sumry-title">Balance</h3>
          <p id="balance">$0.00</p>
        </div>
      </div>

      <!-- SAVINGS GOAL PLANNER -->
      <div class="goal-card">
        <h3>Savings Goal Planner</h3>

        <form id="goalForm">
          <div class="goal-row">
            <div>
              <label>Target Amount</label>
              <input type="number" id="goalAmount" placeholder="e.g. 500" required>
            </div>

            <div>
              <label>Target Date</label>
              <input type="date" id="goalDate" required>
            </div>
          </div>

          <button type="submit" class="save-btn">Save Goal</button>
        </form>

        <div id="goalDetails" class="goal-details hidden">
          <p>Current Saved: $<span id="goalCurrent">0.00</span></p>
          <p>Suggested Monthly Saving: $<span id="goalMonthly">0.00</span></p>
          <p>Months Left: <span id="goalMonths">0</span></p>

          <div class="progress-bar">
            <div id="goalProgressBar" class="progress-bar-inner"></div>
          </div>

          <p>Progress: <span id="goalPercent">0%</span></p>
        </div>
      </div>

    </div> <!-- END center-wrapper -->

    <!-- CHARTS BELOW -->
    <div class="chart-row">

      <div class="chart-container">
        <h3>Spending by Category</h3>
        <canvas id="categoryChart"></canvas>
      </div>

      <div class="chart-container">
        <h3>Income vs Expense (Monthly)</h3>
        <canvas id="monthlyChart"></canvas>
      </div>

    </div>

  </div>
</div>


<script>
  const API = "http://localhost:4000/api";
  const token = localStorage.getItem("token");

  if (!token) window.location.href = "index.html";

  /* === SUMMARY === */
  async function getSummary() {
    const start = document.getElementById('start').value;
    const end = document.getElementById('end').value;

    let url = `${API}/summary`;
    if (start && end) url += `?start=${start}&end=${end}`;

    const res = await fetch(url, {
      headers: { "Authorization": `Bearer ${token}` }
    });

    const data = await res.json();

    document.getElementById('income').textContent = `$${Number(data.total_income).toFixed(2)}`;
    document.getElementById('expense').textContent = `$${Number(data.total_expense).toFixed(2)}`;
    document.getElementById('balance').textContent = `$${Number(data.balance).toFixed(2)}`;
  }

  /* === PIE CHART === */
  async function loadCategoryChart() {
    const res = await fetch(`${API}/charts/category-totals`, {
      headers: { "Authorization": `Bearer ${token}` }
    });

    const data = await res.json();

    const labels = Object.keys(data);
    const values = Object.values(data);

    const ctx = document.getElementById('categoryChart').getContext('2d');

    new Chart(ctx, {
      type: 'pie',
      data: {
        labels,
        datasets: [{
          data: values,
          backgroundColor: ['#ff6384','#36a2eb','#ffce56','#4bc0c0','#9966ff','#ff9f40']
        }]
      }
    });
  }

  /* === BAR CHART === */
  async function loadMonthlyChart() {
    const res = await fetch(`${API}/charts/monthly-summary`, {
      headers: { "Authorization": `Bearer ${token}` }
    });

    const data = await res.json();
    const ctx = document.getElementById("monthlyChart").getContext("2d");

    new Chart(ctx, {
      type: "bar",
      data: {
        labels: data.months,
        datasets: [
          { label: "Income", data: data.income, backgroundColor: "#10b981" },
          { label: "Expense", data: data.expense, backgroundColor: "#ef4444" }
        ]
      }
    });
  }

  /* === GOAL PLANNER === */
  const GOAL_API = `${API}/goals`;

  const goalForm = document.getElementById('goalForm');

  async function loadGoal() {
    const res = await fetch(GOAL_API, {
      headers: { "Authorization": `Bearer ${token}` }
    });

    const data = await res.json();
    const details = document.getElementById('goalDetails');

    if (!data.hasGoal) {
      details.classList.add('hidden');
      return;
    }

    details.classList.remove('hidden');

    document.getElementById('goalCurrent').textContent = data.current_saved;
    document.getElementById('goalMonthly').textContent = data.monthly_needed;
    document.getElementById('goalMonths').textContent = data.months_left;
    document.getElementById('goalPercent').textContent = `${data.percent}%`;

    document.getElementById('goalProgressBar').style.width = `${data.percent}%`;
  }

  goalForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const target_amount = document.getElementById('goalAmount').value;
    const target_date = document.getElementById('goalDate').value;

    const res = await fetch(GOAL_API, {
      method: 'POST',
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ target_amount, target_date })
    });

    const data = await res.json();
    alert(data.message);
    loadGoal();
  });

  function logout() {
    localStorage.removeItem('token');
    window.location.href = "index.html";
  }

  /* === INITIAL LOAD === */
  getSummary();
  loadCategoryChart();
  loadMonthlyChart();
  loadGoal();

</script>

</body>
</html>
