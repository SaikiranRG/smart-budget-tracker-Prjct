<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Transactions - Smart Budget Tracker</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

  <div class="layout">

    <!-- Sidebar -->
    <div class="sidebar">
      <h2>Smart Budget</h2>

      <button onclick="window.location.href='dashboard.html'">Dashboard</button>
      <button onclick="window.location.href='transactions.html'">Transactions</button>

      <button style="background:#ef4444;" onclick="logout()">Logout</button>
    </div>

    <!-- Main Content -->
    <div class="content">

      <div class="page-title">Add New Transaction</div>

      <div class="form-card">

        <form id="transactionForm" class="transaction-grid">

          <div>
            <label>Type</label>
            <select id="type" required>
              <option value="income">Income</option>
              <option value="expense">Expense</option>
            </select>
          </div>

          <div>
            <label>Category</label>
            <select id="category" required>
              <option value="Food">Food</option>
              <option value="Rent">Rent</option>
              <option value="Travel">Travel</option>
              <option value="Bills">Bills</option>
              <option value="Entertainment">Entertainment</option>
              <option value="Other">Other</option>
            </select>
          </div>

          <div>
            <label>Amount</label>
            <input type="number" id="amount" placeholder="e.g. 100.50" required>
          </div>

          <div>
            <label>Date</label>
            <input type="date" id="date" required>
          </div>

          <div class="full-width">
            <label>Description</label>
            <input type="text" id="description" placeholder="Optional note">
          </div>

          <div class="button-row">
            <button type="submit" class="save-btn">Save Transaction</button>
            <button type="button" class="download-btn" onclick="downloadCSV()">Download CSV</button>
          </div>

        </form>
      </div>

      <h2 class="section-title">Transaction History</h2>

      <table id="transactionsTable">
        <thead>
          <tr>
            <th>Type</th>
            <th>Category</th>
            <th>Amount</th>
            <th>Date</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

    </div> <!-- END CONTENT -->

  </div> <!-- END LAYOUT -->

  <script>
    const API_BASE = 'http://localhost:4000/api';
    const token = localStorage.getItem('token');

    if (!token) window.location.href = 'index.html';

    const transactionForm = document.getElementById('transactionForm');
    const transactionsTable = document.querySelector('#transactionsTable tbody');

    transactionForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const type = document.getElementById('type').value;
      const category = document.getElementById('category').value;
      const amount = document.getElementById('amount').value;
      const date = document.getElementById('date').value;
      const description = document.getElementById('description').value;

      const res = await fetch(`${API_BASE}/transactions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ type, category, amount, date, description })
      });

      const data = await res.json();
      alert(data.message);
      loadTransactions();
    });

    async function loadTransactions() {
      const res = await fetch(`${API_BASE}/transactions`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      const data = await res.json();
      transactionsTable.innerHTML = '';

      if (!data.transactions || data.transactions.length === 0) {
        transactionsTable.innerHTML = `<tr><td colspan="5">No transactions found.</td></tr>`;
        return;
      }

      data.transactions.forEach(t => {
        transactionsTable.innerHTML += `
          <tr>
            <td>${t.type}</td>
            <td>${t.category}</td>
            <td>${t.amount}</td>
            <td>${t.date}</td>
            <td>${t.description || ''}</td>
          </tr>`;
      });
    }

    function logout() {
      localStorage.removeItem('token');
      window.location.href = "index.html";
    }

    function downloadCSV() {
      fetch(`${API_BASE}/export/csv`, {
        method: "GET",
        headers: {
          "Authorization": `Bearer ${token}`
        }
      })
        .then(response => {
          if (!response.ok) {
            alert("No data to export");
            return;
          }
          return response.blob();
        })
        .then(blob => {
          if (!blob) return;
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "transactions.csv";
          document.body.appendChild(a);
          a.click();
          a.remove();
        });
    }

    loadTransactions();
  </script>

</body>

</html>
